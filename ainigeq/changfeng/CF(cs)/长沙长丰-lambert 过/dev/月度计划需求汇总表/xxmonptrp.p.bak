/*By: Lambert Xiang 2010/01/28 ECO: *SS 20100128* */


{mfdtitle.i "20100128"}

DEFINE VARIABLE part like mrp_part. 
DEFINE VARIABLE part1 like mrp_part.
DEFINE VARIABLE date1 as date.      
DEFINE VARIABLE date2 as date.      
DEFINE VARIABLE ptline like pt_prod_line. 
DEFINE VARIABLE ptline1 like pt_prod_line.
DEFINE VARIABLE buyer like pt_buyer. 
DEFINE VARIABLE buyer1 like pt_buyer.
DEFINE VARIABLE vend like pt_vend. 
DEFINE VARIABLE vend1 like pt_vend.

DEFINE VARIABLE qcqty like tr_qty_loc.	/*期初数*/
DEFINE VARIABLE qmqty like tr_qty_loc.	/*期末数*/
DEFINE VARIABLE inpqty like tr_qty_loc.	/*计划入库数*/
DEFINE VARIABLE outpqty like tr_qty_loc.	/*计划出库数*/

DEFINE TEMP-TABLE tmp_mstr 
	field tmp_part like pt_part			/*物料编码*/
	field tmp_buyer like pt_buyer			/*采购员编码*/
	field tmp_vend like pt_vend			/*供应商编码*/
	field tmp_ptline like pt_prod_line			/*产品线编码*/
	field tmp_qty_safe like pt_sfty_stk		/*安全库存数*/
	field tmp_qty1 like ld_qty_oh		/*大于截至日期的入库事务的入库数*/
	field tmp_qty2 like ld_qty_oh		/*大于截至日期的出库事务的出库数*/
	field tmp_qty3 like ld_qty_oh		/*本期入库*/
	field tmp_qty4 like ld_qty_oh		/*本期出库*/
	field tmp_qty14 like ld_qty_oh		/*库存数*/
	.

form 
	date1					colon 15
	date2					colon 45
	part					colon 15
	part1   label {t001.i}	colon 45 
	ptline	  		colon 15
	ptline1	label {t001.i}	colon 45
	buyer	    		colon 15
	buyer1 	label {t001.i}	colon 45
	vend  	  		colon 15
	vend1 	label {t001.i}	colon 45
	skip(1)

with frame a side-labels width 80 attr-space.

setFrameLabels(frame a:handle).

{wbrp01.i}

REPEAT ON ENDKEY UNDO, LEAVE: 
	if part1 = hi_char then part1 = "".
	if buyer1 = hi_char then buyer1 = "".
	if prline1 = hi_char then prline1 = "".
	if vend1 = hi_char then vend1 = "".
	if date1 = low_date then date1 = ?.
	if date2 = hi_date  then date2 = ?.
	
	IF c-application-mode <> 'web':u THEN
	update date1 date2 part part1 ptline ptline1 buyer buyer1 vend vend1 WITH FRAME a.

	{wbrp06.i &command = UPDATE
		&fields = "date1 date2 part part1 ptline ptline1 buyer buyer1 vend vend1 "
		&frm = "a"}
	if part1 = "" then part1 = hi_char.
	if buyer1 = "" then buyer1 = hi_char.
	if prline1 = "" then prline1 = hi_char.
	if vend1 = "" then vend1 = hi_char.
	if date1 = ? then  date1 = low_date.
	if date2 = ? then date2 = hi_date.

	{mfselprt.i "printer" 132}

	for each tmp_mstr :
		delete tmp_mstr .
	end.

	for each  pt_mstr where pt_part >= part
		and pt_part <= part1 
		and pt_prod_line >= ptline
		and pt_prod_line <= ptline1
		and pt_buyer >= buyer
		and pt_buyer1 <= buyer1
		and pt_vend >= vend
		and pt_vend <= vend1
		no-lock:
			
			for each tr_hist where tr_part = pt_part
				and tr_effdate >= date1
				and tr_qty_loc <> 0
				and tr_ship_type = ""
				no-lock 
				:
				find first tmp_mstr where tmp_part = tr_part  no-error .
				if not avail tmp_mstr then do :
					create tmp_mstr .
					assign 
						tmp_part = tr_part
						tmp_qty_safe = pt_sfty_stk
						.
				end.
				if tr_effdate <= date2 then do :
					if ( tr_type begins "RCT" or tr_type = "CN-RCT" or (tr_type = "CYC-RCNT" and tr_qty_loc > 0 )or tr_type = "TAG-CNT" ) 
						then tmp_qty3 = tmp_qty3 + tr_qty_loc.
						else tmp_qty4 = tmp_qty4 - tr_qty_loc.
			
				end.

				if tr_effdate > date2 then do :
					if ( tr_type begins "RCT" or tr_type = "CN-RCT" or (tr_type = "CYC-RCNT" and tr_qty_loc > 0 )or tr_type = "TAG-CNT" ) 
					then tmp_qty1 = tmp_qty1 + tr_qty_loc.
					else tmp_qty2 = tmp_qty2 - tr_qty_loc.
				end.
		  end.
		  for each ld_det where ld_part = pt_part
			  and ld_qty_oh <> 0
			  no-lock:
			  find first tmp_mstr where tmp_part = ld_part  no-error .
  			if not avail tmp_mstr then do :
	  			create tmp_mstr .
		  		assign 
			  		tmp_part = ld_part 
				  	.
  			end.
	  		tmp_qty14 = tmp_qty14 + ld_qty_oh .
  		end.
	end.

	
	for each tmp_mstr no-lock break by tmp_part :
		/*计算期初及结存数*/
		qmqty = 0 .
		qcqty = 0 .
		outpqty = 0.
		inpqty = 0.
		qcqty = tmp_qty14 - tmp_qty1 + tmp_qty2 - tmp_qty3 + tmp_qty4 .
		for each wo_mstr where wo_due_date >= date1 
		  and wod_due_date <= date2 
		  no-lock:
			for each wod_det where wod_part = tmp_part 
			  no-lock:
				outpqty = outpqty + wod_qty_req.
			end.
	  end.
		for each sod_det where sod_part = tmp_part 
		  and sod_due_date >=date1 
		  and sod_due_date <=date2 
		  no-lock:
			outpqty = outpqty + sod_qty_ord.
		end.
		for each pod_det where pod_part = tmp_part 
		  and pod_due_date >= date1 
		  and pod_due_date <=date2
		  no-lock:
		  inpqty = inpqty + pod_qty_ord.
		end.
		find first pt_mstr where pt_part = tmp_part no-lock no-error .
		display 
			tmp_part								column-label "物料编码"
			trim (pt_desc1) + trim (pt_desc2)		column-label "物料名称" format "x(24)"
			qcqty									column-label "期初库存"
			outpqty               column-label "计划消耗"
			tmp_qty_safe          column-label "安全库存"
			qcqty - outpqty - tmp_qty_safe  column-label "本期需求数"
			inpqty                column-label "本期采购数"
			
		with stream-io	width 320.
	end .
	{mfreset.i}
	{mfgrptrm.i}
END.

{wbrp04.i &frame-spec = a}

