 {bcdeclre.i}

DEFINE SHARED VARIABLE cimcase AS CHARACTER.

     /*DEF SHARED TEMP-TABLE t_error
        FIELD t_er_code AS CHAR FORMAT "x(18)"
       FIELD t_er_mess AS CHAR FORMAT "x(30)".*/
     /*   DEF SHARED TEMP-TABLE btrid_tmp
            FIELD btrid LIKE b_tr_id.*/
        FIND FIRST b_ct_ctrl NO-LOCK NO-ERROR.

FIND FIRST b_bf_det  EXCLUSIVE-LOCK WHERE b_bf_tocim = YES /*AND b_bf_sess = g_user*/ AND b_bf_program = cimcase NO-ERROR.
IF AVAILABLE b_bf_det THEN DO:

    OUTPUT TO 'e:\repcim.cim'.
     PUT "@@batchload ". PUT  b_bf_program SKIP.
     PUT '"'. PUT "BJW". PUT '"' SKIP.
     PUT '"' . PUT CONTROL b_bf_date. PUT '" - "'. PUT CONTROL b_bf_site. PUT '"' SKIP.
     PUT '"'. PUT CONTROL b_bf_part. PUT '" "'. PUT CONTROL b_bf_bc01. PUT '" "'. PUT CONTROL b_bf_ref. PUT '"' SKIP. 
     PUT "-" SKIP.
     PUT "-" SKIP.
     PUT "- ". PUT CONTROL b_bf_qty_loc. PUT " -" SKIP.
     PUT "-" SKIP.
     PUT "yes" SKIP.
     PUT "." SKIP.
     PUT "." SKIP.
     PUT "@@end".
    OUTPUT CLOSE.
END.  /*if available b_bf_det*/

    {bcrun.i ""bcmgbdpro.p"" "(INPUT ""e:\repcim.cim"",INPUT ""e:\x"")"}

FIND FIRST wo_mstr NO-LOCK WHERE wo_part = b_bf_part NO-ERROR.
IF AVAILABLE wo_mstr THEN DO:
   FIND FIRST wod_det NO-LOCK WHERE wod_lot = wo_lot AND string(wod_op) = b_bf_bc01 NO-ERROR.
   IF AVAILABLE wod_det THEN DO:
       FIND FIRST tr_hist NO-LOCK WHERE tr_part = wod_part AND tr_type = "ISS-WO" NO-ERROR.
       IF AVAILABLE tr_hist THEN DO:
          CREATE b_tr_hist.
          ASSIGN b_tr_nbr = tr_nbr
              b_tr_line = tr_line
              b_tr_code = ""
              b_tr_part = tr_part
              b_tr_lot = tr_lot
              /*b_tr_ser = tr_ser*/
              b_tr_qty_ord = tr_qty_req
              b_tr_qty_chg = tr_qty_chg
              b_tr_qty_loc = tr_qty_loc
              b_tr_um = tr_um
              b_tr_um1 = ""
              b_tr_um2 = ""
              b_tr_std_cost = 0
              b_tr_cur_cost = 0
              b_tr_tr_cost = 0
              b_tr_date = tr_date
              b_tr_tr_date = tr_date
              b_tr_eff_date = tr_date
              b_tr_type = tr_type
              b_tr_id = tr_trnbr
              b_tr_trnbr = tr_trnbr
              b_tr_time = tr_time
              b_tr_loc = tr_loc
              b_tr_site = tr_site.

          b_bf_tocim = NO.
       END.
   END.
END.

MESSAGE "completed" VIEW-AS ALERT-BOX.
E "completed" VIEW-AS ALERT-BOX.
