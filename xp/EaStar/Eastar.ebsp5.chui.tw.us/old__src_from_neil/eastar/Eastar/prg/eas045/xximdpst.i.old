        message "Invoice posting...".
        FOR EACH xcim_sod_det:
        	delete xcim_sod_det.
        END.
        inv_post = no.
        for each shad_det  where shad_sanbr >= sanbr and shad_sanbr <= sanbr1 and shad_line > 0 
        and shad_inv_qty > 0 and shad_ii_nbr <> ""
        EXCLUSIVE-LOCK break by shad_ii_nbr:
            inv_post = yes.
            to_inv_qty = shad_inv_qty.
            for each sod_det exclusive-lock where to_inv_qty > 0 and sod_nbr = shad_so_nbr and sod_qty_inv > 0 
            break by sod_due_date :
                find so_mstr where so_nbr = sod_nbr exclusive-lock no-error.
                if available so_mstr then assign so_inv_nbr = shad_ii_nbr so_invoiced = yes so_to_inv = no.
                create xcim_sod_det.
                assign xcim_sod_nbr		    = sod_nbr
                       xcim_sod_inv_date    = today
                       xcim_sod_line	    = sod_line
                       xcim_sod_qty_ship    = min(to_inv_qty,sod_qty_inv)
/*                       xcim_sod_site	    = "EAST"
                       xcim_sod_loc		    
                       xcim_sod_lot		
                       xcim_sod_ref		
                       xcim_sod_rmks	*/
                       xcim_sod_inv_nbr	    = shad_ii_nbr
/*                       xcim_sod_qty_ship_old
                       xcim_sod_qty_inv_old 
                       xcim_ship_successful 
                       xcim_post_successful */


                shad_inv_qty = shad_inv_qty - max(0,sod_qty_inv).
                shad_qty_inv = shad_qty_inv + max(0,sod_qty_inv).

                to_inv_qty = to_inv_qty - sod_qty_inv.
                if to_inv_qty <= 0 or last(sod_due_date) then do:
                    if can-find(first xcim_sod_det) then do:
					{gprun.i ""xxciivps.p"" "(output vchr_status)"}
					IF vchr_status = 1 THEN DO:
						MESSAGE "Invoice can not be posted." VIEW-AS ALERT-BOX.
						UNDO mainloop,LEAVE mainloop.  
					END.
                    FOR EACH xcim_sod_det:
                    	delete xcim_sod_det.
                    END.
                    end.
                    else message "No invoice to post".
                    leave.
                end.

            end.
        end.
        if inv_post then message "No invoice to post".
        else message "Invoice posted".