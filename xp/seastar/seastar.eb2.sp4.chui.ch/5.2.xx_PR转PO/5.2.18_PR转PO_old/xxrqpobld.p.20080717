/* rqpobld.p - Requisition Purchase Build Maintenance                       */
/* Copyright 1986-2002 QAD Inc., Carpinteria, CA, USA.                      */
/* All rights reserved worldwide.  This is an unpublished work.             */
/* $Revision: 1.9.1.11 $                                                            */
/*V8:ConvertMode=ReportAndMaintenance                                       */
/* REVISION 8.5       LAST MODIFIED: 04/15/97  BY: *J1Q2* Patrick Rowan     */
/* REVISION 8.5       LAST MODIFIED: 10/28/97  BY: *J24N* Patrick Rowan     */

/* REVISION: 8.6E     LAST MODIFIED: 02/23/98  BY: *L007* A. Rahane         */
/* REVISION: 8.6E     LAST MODIFIED: 03/31/98  BY: *J2G7* Samir Bavkar      */
/* REVISION: 8.6E     LAST MODIFIED: 05/20/98  BY: *K1Q4* Alfred Tan        */
/* REVISION: 8.6E     LAST MODIFIED: 10/04/98  BY: *J314* Alfred Tan        */
/* REVISION: 9.1      LAST MODIFIED: 03/24/00 BY: *N08T* Annasaheb Rahane   */
/* REVISION: 9.1      LAST MODIFIED: 08/12/00 BY: *N0KP* myb                */
/* Old ECO marker removed, but no ECO header exists *F0PN*                  */
/* Revision: 1.9.1.10      BY: Mugdha Tambe   DATE: 10/01/01 ECO: *P012*      */
/* $Revision: 1.9.1.11 $            BY: Rajaneesh S.   DATE: 08/29/02 ECO: *M1BY*      */
/******************************************************************************/
/* All patch markers and commented out code have been removed from the source */
/* code below. For all future modifications to this file, any code which is   */
/* no longer required should be deleted and no in-line patch markers should   */
/* be added.  The ECO marker should only be included in the Revision History. */
/******************************************************************************/

/*!
 ----------------------------------------------------------------------------
 DESCRIPTION: Copy requisitions to a new or existing purchase order.
              Supports the multi-line Purchase Requisition Module of MFG/PRO.

 Notes:
 1) Valid requisitions must be approved and routed to the buyer.
 2) Valid requisition lines must contain open qty.
 3) Requisition lines marked out of tolerence can be put on a PO, and
    will be re-evaluated for out of tolerence during PO Maintenance.
 4) Valid purchase orders are open orders, not closed or cancelled.
 5) Purchase orders cannot be blanket orders.

============================================================================
!*/
{mfdtitle.i "2+ "}

/* ********** Begin Translatable Strings Definitions ********* */

&SCOPED-DEFINE rqpobld_p_1 "Requisition"
/* MaxLen: Comment: */

&SCOPED-DEFINE rqpobld_p_2 "Blank Suppliers Only"
/* MaxLen: Comment: */

&SCOPED-DEFINE rqpobld_p_3 "Include MRO Items"
/* MaxLen: Comment: */

&SCOPED-DEFINE rqpobld_p_4 "Include MRP Items"
/* MaxLen: Comment: */

&SCOPED-DEFINE rqpobld_p_5 "Default Copy"
/* MaxLen: Comment: */

&SCOPED-DEFINE rqpobld_p_6 "Req Ln!PO Nbr"
/* MaxLen:8 Comment: */

&SCOPED-DEFINE rqpobld_p_7 "Site!PO Line"
/* MaxLen:8 Comment: */

&SCOPED-DEFINE rqpobld_p_8 "Item Number!Qty Ordered"
/* MaxLen:12 Comment: */

&SCOPED-DEFINE rqpobld_p_9 "Supplier!UM"
/* MaxLen:8 Comment: */

&SCOPED-DEFINE rqpobld_p_10 "Due Date!Disc %"
/* MaxLen:8 Comment: */

&SCOPED-DEFINE rqpobld_p_11 "Purchase Cost!Extended Cost"
/* MaxLen:15 Comment: */

&SCOPED-DEFINE rqpobld_p_12 "Ln"
/* MaxLen:3 Comment: */

&SCOPED-DEFINE rqpobld_p_13 "Supplier"
/* MaxLen:6 Comment: */

/* ********** End Translatable Strings Definitions ********* */

/* VARIABLES */
define variable req_nbr               like rqm_mstr.rqm_nbr no-undo
   label {&rqpobld_p_1}.
define variable req_nbr1              like rqm_mstr.rqm_nbr no-undo.
define variable supplier              like rqm_vend no-undo.
define variable supplier1             like rqm_vend no-undo.
define variable need_date             like rqd_need_date no-undo.
define variable need_date1            like rqd_need_date no-undo.
define variable part                  like rqd_part    no-undo.
define variable part1                 like rqd_part    no-undo.
define variable site                  like rqd_site    no-undo.
define variable buyer_id              like rqm_buyer   no-undo.
define variable job_name              like rqm_job     no-undo.
define variable ship                  like rqd_ship    no-undo.
define variable currency              like rqm_curr    no-undo.
define variable requester             like rqm_rqby_userid no-undo.
define variable open_qty              like rqd_req_qty no-undo.
define variable qty_um                like rqd_um      no-undo.
define variable l_subject             as   character   no-undo.
define variable l_reqlist             as   character   no-undo.
define variable l_emailsent           like mfc_logical no-undo.
define variable l_povend              like po_vend     no-undo.
define variable l_end                 as   character format "x(35)" no-undo.

/* LOGICALS */                                     
define variable blank_suppliers       like mfc_logical no-undo
   label {&rqpobld_p_2}.
define variable default_copy          like mfc_logical no-undo
   label {&rqpobld_p_5}.
define variable include_mrp_type      like mfc_logical no-undo
   label {&rqpobld_p_4}.
define variable include_mro_type      like mfc_logical no-undo
   label {&rqpobld_p_3}.

/* COUNTERS */
define variable rqpo_wrk_cntr         as integer no-undo.
define variable using_grs            like mfc_logical no-undo.

define var v_nbr like po_nbr .
define var v_new as logical label "新增" .
define variable v_effdate             as date initial today . 
define variable v_vend                like po_vend .
define var      v_price               like pc_amt[1] .
define var      v_curr                like pc_curr .
define var v_err as logical label "显示错误" initial yes .
define variable isAuthorized        as integer initial 0  .
define var v_num  as integer .
define var v_ok1 as logical .


define var curr1 like po_curr .
define var curr2 like po_curr .
define var ratetype like exr_ratetype .
define var r1 like exr_rate .
define var r2 like exr_rate2.
define var seq as integer .
define var error as integer .




/* TEMP TABLE for last disp  */
define temp-table newpo
	field n_nbr   like po_nbr .

/* TEMP TABLE for xxrqpoblda.p windows */
define new shared temp-table rq_wrk 
   field rq_nbr                     like rqm_mstr.rqm_nbr label "申请号"
   field rq_line                    like rqd_line label "项次"
   field rq_site                    like rqd_site label "地点"
   field rq_item                    like rqd_part       label "零件号"
   field rq_net_qty                 like rqd_req_qty    label "未结数量"
   field rq_need_date               as date  label "需要日期"
   field rq_supplier                like rqd_vend     label "供应商"
   field rq_ship                    like rqd_ship     label "交运地"
   field rq_buyer_id                like rqm_buyer    label "采购员"
   field rq_copy_to_po              like mfc_logical  label "复制"
   index rq_index1                  is unique primary
   rq_nbr ascending
   rq_line ascending.




/* CONSTANTS */
{rqconst.i}

/* SHARED VARIABLES*/
{xxrqpovars.i "NEW"}

/*STREAMS*/
define stream mailNotice.

/* FRAME Z: SELECTION FORM */
form
	skip(1) 
   site                colon 20
   req_nbr             colon 20
   req_nbr1            colon 49 label {t001.i}
   /*supplier            colon 20
   supplier1           colon 49 label {t001.i}*/
   part                colon 20
   part1               colon 49 label {t001.i}
   need_date           colon 20
   need_date1          colon 49 label {t001.i}
   skip(1) 
   buyer_id            colon 20   
   requester           colon 20
   v_err               colon 20

/* /*xp001*/   job_name            colon 36 */
/* /*xp001*/   ship                colon 36 */
/* /*xp001*/   currency            colon 36 */
/* /*xp001*/   blank_suppliers     colon 36 */
/* /*xp001*/   include_mrp_type    colon 36 */
/* /*xp001*/   include_mro_type    colon 36 */
/* /*xp001*/   include_hcmmts      colon 36 */
/* /*xp001*/   include_lcmmts      colon 36 */
/* /*xp001*/   default_copy        colon 36 */
skip(3)
with frame z side-labels width 80 attr-space.

/* SET EXTERNAL LABELS */
setFrameLabels(frame z:handle).

using_grs = can-find(mfc_ctrl
               where mfc_field   = "grs_installed"
                 and mfc_logical = yes).


form
   pod_req_nbr
   pod_req_line column-label {&rqpobld_p_12}
   pod_nbr
   pod_line
   pod_due_date
   pod_part
   pod_qty_ord
   pod_um
   l_povend label {&rqpobld_p_13}
with frame emailnotice width 80   down.

/* SET EXTERNAL LABELS */
setFrameLabels(frame emailnotice:handle).

if not using_grs then do:
   {pxmsg.i &MSGNUM=2122 &ERRORLEVEL=4}
   /*GRS not enabled*/

   if not batchrun then pause.
   leave.
end. /* if not using_grs then do: */

assign
   include_hcmmts = yes
   include_lcmmts = yes
   default_copy = yes
   /*buyer_id  = global_userid*/
   site = "10000" 
   include_mrp_type = yes
   include_mro_type = yes.

mainloop:
repeat:

   if req_nbr1 = hi_char then req_nbr1 = ''.
   if supplier1 = hi_char then supplier1 = ''.
   if part1 = hi_char then part1 = ''.
   if need_date = low_date then need_date = ?.
   if need_date1 = hi_date then need_date1 = ?.
   
   hide all no-pause .   /*xp001*/
   display dtitle format "x(78)"
       with no-labels width 80 row 1 column 2
       frame dtitle no-box no-attr-space.  /*xp001*/
   update
		site
      req_nbr
      req_nbr1
/*      supplier
      supplier1*/
      part
      part1
      need_date
      need_date1
      buyer_id
      
      requester
	  v_err
/*       job_name		 */
/*       ship			 */
/*       currency		 */
/*       blank_suppliers  */
/*       include_mrp_type */
/*       include_mro_type */
/*       include_hcmmts   */
/*       include_lcmmts   */
/*       default_copy     */
   with frame z.

   if req_nbr1 = '' then req_nbr1 = hi_char.
   if supplier1 = '' then supplier1 = hi_char.
   if part1 = '' then part1 = hi_char.
   if need_date = ? then need_date = low_date.
   if need_date1 = ? then need_date1 = hi_date.

   /*  INITIALIZE  */
   assign
      rqpo_wrk_cntr = 0
/*xp001*/      info_correct  = no
      return_code   = 0.


   /*  RETRIEVE RECORDS AND LOAD TEMP-TABLE */
   find first si_mstr where si_site = site no-lock no-error .
   if avail si_mstr then do:

		  {gprun.i ""gpsiver.p"" 
			 "(input Site,
			   input ?,
			   output isAuthorized)"}

		  if isAuthorized = 0 then do:
				/* MESSAGE #725 - USER DOES NOT HAVE ACCESS TO THIS SITE. */
				message "用户没有这个地点的存取权限" view-as alert-box .
				undo,retry mainloop .
		  end.
	end.
	else do:
		message "地点:" site "无效,请重新输入." view-as alert-box.
		undo,retry mainloop .
	end.


   find first rqpo_wrk where rqpo_site = site no-lock no-error .
   if avail rqpo_wrk then do:
		message "地点" site "正在执行,请退出." view-as alert-box.
		undo,retry mainloop .
   end.

   {gprun.i ""xxrqpoblde.p""
      "(input true,
        input req_nbr,
        input req_nbr1,
        input supplier,
        input supplier1,
        input part,
        input part1,
        input need_date,
        input need_date1,
        input buyer_id,
        input site,
        input requester,
        input job_name,
        input ship,
        input currency,
        input blank_suppliers,
        input include_mrp_type,
        input include_mro_type,
        input default_copy,
        output rqpo_wrk_cntr)"}

   if rqpo_wrk_cntr = 0 then do:

		message "无符合条件的请购明细1.".
    	pause.
      /* NO REQUISITIONS AVAILABLE FOR PROCESSING */

   end. /* if rqpo_wrk_cntr = 0 then do: */
   else do:  /* IF rqpo_wrk_cntr <> 0 */
    

		 /*xp001*/  /*  add--------------------------------    */


		 /*xp001****lock tables here **************/
message "正在锁定本地点未结请购单..." .
		{xxrqpobldlk01.i  
			&file-name      = rqd_det use-index rqd_site 
			&group-criteria = "rqd_det.rqd_site = site and ( rqd_open or rqd_status = '' ) "
			&undo-block     = mainloop
			&retry          = "retry mainloop"
		} 

		{xxrqpobldlk01.i  
			&file-name      = rqm_mstr  use-index rqm_open 
			&group-criteria = "rqm_mstr.rqm_open and rqm_site = site  "
			&undo-block     = mainloop
			&retry          = "retry mainloop"
		} 

		/*rqm_site = "" 怎么处理? */


		/*{xxrqpobldlk01.i  
			&file-name      = pod_det
			&group-criteria = "pod_det.pod_site = site "
			&undo-block     = mainloop
			&retry          = "retry mainloop"
		}  
		{xxrqpobldlk01.i  
			&file-name      = po_mstr
			&group-criteria = "po_mstr.po_site = site and po_stat = '' and po__chr01 = '' and po__chr02 = 'A' "
			&undo-block     = mainloop
			&retry          = "retry mainloop"
		}  */

		/*po_site = "" 怎么处理? */
message "锁定完成" .

		/************************************xp001*/


		  for each rqpo_wrk where rqpo_site = site exclusive-lock ,
			  each rqm_mstr where rqm_nbr = rqpo_nbr exclusive-lock ,
			  each rqd_det  where rqd_nbr = rqpo_nbr and rqd_line = rqpo_line no-lock 
			  break by rqpo_site by rqpo_supplier by rqpo_item  :   

			  if first-of(rqpo_item) then do:
				  v_vend = "".
				  v_curr = "RMB" .
				  v_price  = 0 .

				  {gprun.i ""xxpclwst.p""
						  "(input rqpo_item ,
							input rqd_um ,
							output v_vend,
							output v_curr,
							output v_price)"}

			  end. /* if first-of(rqpo_item) */

			  if v_vend = "" then do:
					rqpo_copy_to_po = no .
					rqpo_supplier = "无有效价格表" .
					/*无价格表*/
			  end.
			  else /*if rqpo_supplier = "" then*/  do:
				  find first ad_mstr where ad_addr = v_vend no-lock no-error .
				  find first vd_mstr where vd_addr = v_vend no-lock no-error .
				  if (not avail ad_mstr ) or (not avail vd_mstr ) then do:
						rqpo_copy_to_po = no .
						rqpo_supplier = "无供应商的价格表:" + v_vend .
						/*无供应商*/
				  end.
				  else do:
						if v_curr <> base_curr then do:
								curr1 = v_curr .
								curr2 = base_curr .
								ratetype = "" .
								{gprunp.i "mcpl" "p" "mc-create-ex-rate-usage"
										"(input curr1,
										  input curr2,
										  input ratetype ,
										  input v_effdate ,
										  output r1,
										  output r2,
										  output seq,
										  output error)"}
								if error <> 0 then do:
										   rqpo_copy_to_po = no .
										   rqpo_supplier = "兑换率不存在:" + v_curr . 
										   /*兑换率不存在*/        
								end.
								else do:
									rqpo_supplier = v_vend .
									rqm_curr = v_curr .
								end.

						end.
						else do:
							rqpo_supplier = v_vend .
							rqm_curr = v_curr .
						end.					
				  end.              
			  end.

		  end.  /* for each rqpo_wrk */
		
		hide frame z  no-pause .
		for each rq_wrk :
			delete rq_wrk .
		end.
		v_num = 0 .
		for each rqpo_wrk exclusive-lock  
				  where rqpo_copy_to_po and rqpo_site = site
				  break by rqpo_site by rqpo_supplier by rqpo_item by rqpo_need_date :
			find first rq_wrk where rq_nbr = rqpo_nbr and rq_line = rqpo_line no-lock no-error .
			if not avail rq_wrk then do:
				v_num = v_num + 1 .
				create rq_wrk.
				assign rq_nbr = rqpo_nbr 
					   rq_line = rqpo_line
					   rq_site = rqpo_site
					   rq_item = rqpo_item
					   rq_net_qty = rqpo_net_qty
					   rq_need_date = rqpo_need_date
					   rq_supplier = rqpo_supplier 
					   rq_ship = rqpo_ship
					   rq_buyer_id = rqpo_buyer_id
					   rq_copy_to_po = rqpo_copy_to_po  .
			end.
		end.

		message "输入范围内的PR项数: " rqpo_wrk_cntr  skip
				"其中可转PO的PR项数: " v_num skip 
		        "如果项数不足,请核查后再执行." view-as alert-box.

		find first rq_wrk no-lock no-error.
		if avail rq_wrk then do:
			{gprun.i ""xxrqpoblda.p""}   /* DISPLAY REQUISITIONSUSING SCROLLING WINDOW */
		end.
		else do:
			message "无符合条件的请购明细2.".
			pause.
		end.


		if info_correct then do: 
					/* hide all no-pause .*/
					for each newpo:
						delete newpo.
					end.

					/* output to /home/mfg/roger/5218tst.txt keep-messages  . */
					for each rqpo_wrk exclusive-lock  
						  where rqpo_copy_to_po and rqpo_site = site  
						  break by rqpo_site by rqpo_supplier by rqpo_item by rqpo_need_date :

						  if first-of(rqpo_supplier) then do:
							  /* create po . SIMILAR TO pomt.p */
							  {gprun.i ""xxrqpobldb.p"" 
										"(input rqpo_supplier ,
										  input rqpo_site ,
										  output v_nbr )"}   
							      
							  
							  find first newpo where n_nbr = v_nbr no-lock no-error.
							  if not avail newpo then do:
									create newpo.
									assign n_nbr = v_nbr .
							  end.
				
						  end. /*if first-of(rqpo_supplier) then*/      
					end. /* for each rqpo_wrk */
					/*output close .*/ 

		end. /*if info_correct then do: */


		/*xp001*/ /*  end add --------------------------------    */  
		/*xp001*/ /*   removed the send email and disp summary procedue */

   end.  /* IF rqpo_wrk_cntr <> 0 */


   loopa:
   do on error undo ,leave
	  on endkey undo ,leave :

		{mfselprt.i "printer" 132 }      
		{mfphead.i }                 
		for each newpo no-lock,
			each po_mstr where po_nbr = n_nbr no-lock,
			each pod_det where pod_nbr = po_nbr no-lock 
			with frame xxx width 132 down :
			setFrameLabels(frame xxx:handle).

			find first rq_wrk where rq_nbr = pod_req_nbr and rq_line = pod_req_line no-lock no-error.
			v_new = if avail rq_wrk then yes else no.
			   
			   disp po_nbr 
					po_vend 
					po_curr 
					pod_line 
					pod_part 
					pod_need 
					pod_qty_ord 
					pod_pur_cost 
					v_new 
					with frame xxx.
			{mfrpchk.i}       

		end. /* for each newpo */


		put skip (4) 
			 "(以上为转移成功信息)" skip 
			 "=======================================================================================" skip
			 "(以下为转移失败信息)" skip .

		if v_err then do :
			for each rqpo_wrk exclusive-lock  
				  where rqpo_copy_to_po = no and rqpo_site = site  
				  break by rqpo_site by rqpo_item by rqpo_nbr by rqpo_line by rqpo_need_date
				  with frame yyy width 132 down :
					disp rqpo_site label "地点"
						 rqpo_nbr  label "请购单号"
						 rqpo_line label "项"
						 rqpo_item label "零件号"
						 rqpo_need_date label "需求日期"
						 rqpo_net_qty   label "未结数量"
						 rqpo_buyer_id  label "采购员"
						 rqpo_supplier  label "备注"  format "x(30)"
						 with frame yyy .

					{mfrpchk.i}
			end.




			v_ok1 = no .
			for each rq_wrk no-lock with frame zzz width 132 down :
				v_ok1 = no . 
				
				/*检查是否PR应结未结*********/
				open_qty = 0.
				{gprun.i ""rqoqty.p""
					"(input true,
					input rq_site,
					input rq_nbr,
					input rq_line,
					output open_qty,
					output qty_um)"}

				if open_qty = 0 then do:
					find first rqd_det where rqd_nbr = rq_nbr and rqd_line = rq_line exclusive-lock no-error.
					if avail rqd_det then do:
						if rqd_open or rqd_status = "" then do:
							assign rqd_open = no  rqd_status = "C" .
						end.
					end.
				end.
				/*********检查是否PR应结未结*/


				/*检查是否PR已转PO*/
				for each newpo no-lock ,
					each pod_det where pod_nbr = n_nbr no-lock :
					if pod_req_nbr = rq_nbr and pod_req_line = rq_line then do:
						v_ok1 = yes.
						leave .
					end.
				end.
				
				/*未转po项次检查是否已经disp*/
				if v_ok1 = no then do:
					find first rqpo_wrk where rqpo_nbr = rq_nbr and rqpo_line = rq_line 
							and rqpo_copy_to_po = no and rqpo_site = site 
					no-lock no-error .
					if not avail rqpo_wrk then do:
						v_ok1 = no .
					end.
					else v_ok1 = yes.
				end.
				
				/*disp*/
				if v_ok1 = no then 					
					disp rq_site label "地点"
						 rq_nbr  label "请购单号"
						 rq_line label "项"
						 rq_item label "零件号"
						 rq_need_date label "需求日期"
						 rq_net_qty   label "未结数量"
						 rq_buyer_id  label "采购员"
						 rq_supplier  label "供应商"  format "x(30)"
						 with frame zzz .
				{mfrpchk.i}

			end. /*for each rq_wrk no-lock*/


		end. /*if v_err then*/

				for each rqpo_wrk where rqpo_site = site  exclusive-lock :
					delete rqpo_wrk .
				end.

				for each rq_wrk:
					delete rq_wrk.
				end.

				for each newpo:
					delete newpo.
				end.
	   
		{mfreset.i}	 /*{mfrtrail.i }   REPORT TRAILER  */ 


   end. /* loopa:*/

		for each rqpo_wrk where rqpo_site = site  exclusive-lock :
			delete rqpo_wrk .
		end.

		for each rq_wrk:
			delete rq_wrk.
		end.

		for each newpo:
			delete newpo.
		end.
				 


end.  /* REPEAT */

