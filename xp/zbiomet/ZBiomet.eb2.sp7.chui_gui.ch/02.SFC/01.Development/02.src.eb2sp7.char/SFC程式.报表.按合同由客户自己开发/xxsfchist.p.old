
      {mfdeclre.i}
      {gplabel.i} /* EXTERNAL LABEL INCLUDE */

      define shared variable v_wc like wc_wkctr.
      define shared variable v_wolot like wo_lot.
      define shared variable v_op like ro_op.

      define variable l_userid like global_userid label "操作员" no-undo.
      define variable wkctr like wc_wkctr label "机器".
      define variable nbr like wo_nbr format "x(10)" label "工单".
      define variable lot like wo_lot label "标志".
      define variable op like ro_op label "OP".
      define variable hrs as decimal format ">>>>9" label "小时".
      define variable eff_date as date label "开始日期".
      define variable start_time as char format "x(5)" column-label "开始!时间".
      define variable end_time as char format "x(5)" column-label "结束!时间".

      wkctr = v_wc.
      lot = v_wolot.
      op = v_op.
      
      find first wo_mstr where wo_lot = lot no-lock no-error.
      nbr = (if available wo_mstr then wo_nbr else "").

      FORM /*GUI*/ 
         l_userid at 3
         nbr      at 19
         lot      at 36
         op       at 51
         wkctr    at 61
	 eff_date at 1
      with frame a row 1 centered overlay side-labels width 80.

      l_userid = global_userid.
      display l_userid with frame a.

      repeat:
         update        
            nbr
            lot
            op
            wkctr
	    eff_date
	 with frame a editing:
            if frame-field = "nbr" then do:
               /* FIND NEXT/PREVIOUS RECORD */
               {mfnp.i wo_mstr nbr wo_nbr nbr wo_nbr wo_nbr}
  
               if recno <> ? then do:
                  nbr = wo_nbr.
		  display nbr with frame a.
	       end.
            end.
            else if frame-field = "lot" then do:
               /* FIND NEXT/PREVIOUS RECORD */
               {mfnp05.i wo_mstr wo_nbr "wo_nbr = nbr" wo_lot "input lot"}

               if recno <> ? then do:
                  lot = wo_lot.
                  display lot with frame a.
	       end.
            end.
            else if frame-field = "wkctr" then do:
               /* FIND NEXT/PREVIOUS RECORD */
               {mfnp05.i wc_mstr
                  wc_wkctr
                 "wc_fsm_type = "" "" "
                  wc_wkctr
                  "input wkctr"}

               if recno <> ? then do:
                  wkctr = wc_wkctr.
                  display wkctr with frame a.
               end.
            end.
            else do:
               status input.
               readkey.
               apply lastkey.
            end.
         end.

         clear frame a all no-pause.

         display
	    wkctr
            nbr
            lot
            op
	    eff_date
	 with frame a.


         /* OUTPUT DESTINATION SELECTION */
         {gpselout.i &printType = "terminal"
               &printWidth = 80
               &pagedFlag = " "
               &stream = " "
               &appendToFile = " "
               &streamedOutputToTerminal = " "
               &withBatchOption = "no"
               &displayStatementType = 1
               &withCancelMessage = "yes"
               &pageBottomMargin = 6
               &withEmail = "yes"
               &withWinprint = "yes"
               &defineVariables = "yes"}

         loopa: 
         for each xxfb_hist no-lock
	    where xxfb_user = l_userid
	      and (wkctr = "" or xxfb_wc = wkctr)
	      and (nbr = "" or xxfb_wonbr = nbr)
	      and (lot = "" or xxfb_wolot = lot)
	      and (op = 0 or xxfb_op = op)
	      and (eff_date = ? or xxfb_date = eff_date)
	 break by xxfb_trnbr
         on endkey undo, leave loopa with frame b 12 down width 80:

            find first code_mstr where code_fldname = "SFC"
	           and code_value = xxfb_type no-lock no-error.

            hrs = (xxfb_time_end - xxfb_time_start) / 60.

	    display
	       xxfb_wc
	       (if available code_mstr then substring(code_cmmt,1,index(code_cmmt,"@") - 1) 
	        else "") @ code_cmmt format "x(9)" label "交易类型"
	       xxfb_date
	       string(xxfb_time_start,"HH:MM") format "x(5)" @ start_time
	       string(xxfb_time_end,"HH:MM") format "x(5)" @ end_time
	       hrs column-label "花费!分钟"
	       xxfb_wolot format "x(7)" label "标志"
	       xxfb_op format ">9" label "OP"
	       xxfb_qty_fb format "->>>>>9"
	       xxfb_rmks format "x(13)"
	    with down frame b.

	    if frame-line(b) = frame-down(b) then pause.

            {mfreset.i}
         end.

        {pxmsg.i &MSGNUM=8 &ERRORLEVEL=1}
      end.

      hide frame a.
         